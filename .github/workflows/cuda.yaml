name: Build and Push CUDA Docker Image

on:
  workflow_dispatch: # Allow manual triggering
  workflow_call: # Allow being called from cuda-base.yaml
    inputs:
      push:
        description: 'Whether to push the image'
        type: boolean
        default: false
    secrets:
      DOCKERHUB_USERNAME:
        required: true
      DOCKERHUB_TOKEN:
        required: true

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Build and push Docker image
        uses: ./.github/actions/docker-build
        with:
          image_name: sebffischer/anvil-cuda
          dockerfile: ./cuda/Dockerfile
          # Push if called with push=true, or manual trigger on main
          push: ${{ inputs.push || (github.event_name == 'workflow_dispatch' && github.ref == 'refs/heads/main') }}
          dockerhub_username: ${{ secrets.DOCKERHUB_USERNAME }}
          dockerhub_token: ${{ secrets.DOCKERHUB_TOKEN }}
